<!DOCTYPE html>
<meta charset="utf-8">
<title> Pack View </title>
<link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">
<style>

button {
  position: absolute;
  right: 30px;
  top: 30px;
}

</style>
<svg width="980" height="980"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="./d3/d3.js"></script> <!-- This is version 4 of the D3 Library -->
<script src="./d3/d3.min.js"></script> <!-- This is version 4 of the D3 min Library -->
<script type="text/javascript" src="./d3-tip/index.js"></script>
<script type="text/javascript">


	var Containers = [],
		default_stroke_width = 0.5,
	highlight_stroke_width = 2,
	canvas_width = 960,
	canvas_height = 960,
	margin = 3,
	//Transition definition for when we switch on/off the visibility of a node.
	visibilityTransition = d3.transition().delay(1000).ease(d3.easeLinear),
	c20c = d3.schemeCategory20c,
	zoom = d3.zoom().scaleExtent([1, 16]).on("zoom", handleZoom),
	svg = d3.select("svg")
		.attr("fill", "black")
		.attr("width", canvas_width)
		.attr("height", canvas_height)
		//.attr("transform", "translate(2,2) scale(1)")
		//.call(zoom)
	canvas = svg.append("g").attr("transform", "translate(2,2) scale(1)").call(zoom),
	tooltip = d3.tip()
		.attr('class', 'd3-tip')
		.html(function(d) { return d.data.name; } );

	canvas.call(tooltip);

	function setNodeFill(d)
	{
		var color =  "black"; //default

		if(d.depth == 0) //root node.
		{
			//Mid Gray
			color = "#a0acbf";
		}
		else if(d.children) //Mid node.
		{
			//Greyish blue
			color = "#6284bc";
		}
		else if(!d.children) //leaf node
		{
			//royal blue
			color = "#1f69e2";
		}

		return color;			
	}

	function setNodeVisibility(d)
	{
		var vis =  "hidden"; //default
		if(d.depth == 0)
		{
			vis =  "visible";
		}
		else if(d.children) //Mid node.
		{
			vis =  "visible";
		}
		else
		{
			vis = "hidden"
		}

		return vis;
	}

	function handleMouseClick(d)
	{		
		if(!d.children)
		{
			window.location.href = "http://localhost:8080/packageNodes.html?container=\"" + d.parent.data.name + "\"" + "&package=\"" + d.data.name + "\"";
		}
	}

	var currentPackage;
	var currentCircle;
	function handleNodeMouseOver(d)
	{
		if(d.depth != 0 && d.children)
		{
			//Show tooltip
			tooltip.show(d);
			currentPackage = d;
			currentCircle = this;
			d3.select(this).style("stroke-width", highlight_stroke_width);
		}			
	}

	function handleNodeMouseOut(d)
	{
		//Show tooltip
		tooltip.hide(d);
		d3.select(this).style("stroke-width", default_stroke_width);
	}

	var zoomedIn = false;
	var focus;
	function handleZoom(d)
	{

		if(!(d3.event.transform.k >= 8))
		{
			canvas.attr("transform", "translate(" + d3.event.transform.x + "," + d3.event.transform.y + ") scale(" + d3.event.transform.k + ")");

			if(d3.event.transform.k >= 4)
			{
				drawLeafNodes(currentPackage);
				focus = currentCircle.parentNode;
				d3.select(focus).select("text").style("visibility", "hidden");
				d3.selectAll(".package").select("circle").style("visibility", "visible");
				d3.selectAll(".package").select("text").style("visibility", "visible");
			}
		}
		else
		{
			deleteLeafNodes();
			d3.select(focus).select("text").style("visibility", "visible");
			d3.selectAll(".package").select("circle").style("visibility", "hidden");
			d3.selectAll(".package").select("text").style("visibility", "hidden");
			canvas.call(zoom.transform, d3.zoomIdentity.translate(2,2).scale(1));
			d3.event.transform.k = 1;
		}
	}

	function getMidNodes(descendants)
	{
		var midNodes = [];
		for(i = 0; i < descendants.length; i++)
		{
			if(descendants[i].children) //We want non-leaf-nodes.
			{
				midNodes.push(descendants[i]);
			}
		}

		return midNodes;
	}

	function deleteLeafNodes()
	{
		canvas.selectAll(".package").remove();
	}

	function drawLeafNodes(d)
	{
			//Create their circle containers that will be drawn into the canvas.
			var packNode = canvas.selectAll(".package")
					.data(d.children)
					.enter()
						.append("g")
								.attr("id", function(d) { return d.data.id; })
								.attr("class", "package")
								.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

			packNode.append("circle")				
				.attr("stroke", "black")
				.attr("stroke-width", default_stroke_width)
				.attr("fill", setNodeFill)
				.attr("r", function(d){ return d.r; })
				.style("visibility", setNodeVisibility)
				.on("mouseover", handleNodeMouseOver)
				.on("mouseout", handleNodeMouseOut)
				.on("dblclick", handleMouseClick);

			var text = packNode.append("text")
					.attr("fill", "black")
					.attr("font-family", "sans-serif")
					.attr("font-size", "5px")
					.attr("text-anchor", "middle")
					//.style("display", function(d) { return d.parent === root ? "inline" : "none"; })
					.attr("visibility", "visible")
					.text(function(d)
						{ 
							var strArray = d.data.name.split(".");
							strArray.pop();
							var formattedName = strArray.join(".").toString();
							return formattedName;
						})
					.style("font-size", "1px")
				    .each(getSize)
	  				.style("font-size", function(d) { return d.scale + "px"; })		
	}

	d3.json("output.json", function(error, data)
	{
		if(error) 
		{
			throw error
		}
		else
		{
			//Create the JSON objects using the CDA generated XML.
			var root = d3.hierarchy(data)
				.sum(function(d) { return d.size; })
				.sort(function(d) {return d.name; });

			// A scale for the circle's radius relative to their size. Size is calculcated using the number of children inside.
			// Example:
			// - Container - total number of JAR files
			// - JAR file - total number of packages
			// - Package = total number of class/interface files inside that package.
			var circleScale = d3.scaleLinear()
				.domain([15, d3.max(data, function(d){ return d.size; })])
				.range([15, 900]);

			var packageScale = d3.scaleLinear()
				.domain([0, d3.max(data, function(d){ return d.size; })])
				.range([15, 900]);

			//Create the pack
			var systemPack = d3.pack()
				.size([canvas_width - margin, canvas_height - margin])
				.padding(2);

			//Create their circle containers that will be drawn into the canvas.
			var packNode = canvas.selectAll(".package")
					.data(getMidNodes(systemPack(root).descendants()))
					.enter()
						.append("g")
								.attr("id", function(d) { return d.data.id; })
								.attr("class", function(d){
									var className = "error";
									if(d.children)
									{
										className = "container";
									}
									else
									{
										className = "package";
									}

									return className;
								})
								.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

			packNode.append("circle")				
				.attr("stroke", "black")
				.attr("stroke-width", default_stroke_width)
				.attr("fill", setNodeFill)
				.attr("r", function(d){ return d.r; })
				.style("visibility", setNodeVisibility)
				.on("mouseover", handleNodeMouseOver)
				.on("mouseout", handleNodeMouseOut)
				.on("dblclick", handleMouseClick);

			var text = packNode.append("text")
					.attr("fill", "black")
					.attr("font-family", "sans-serif")
					.attr("font-size", "5px")
					.attr("text-anchor", "middle")
					//.style("display", function(d) { return d.parent === root ? "inline" : "none"; })
					.attr("visibility", function(d){
						var vis = "hidden";
						if(d.children && d.depth != 0) //mid node
						{
							vis = "visible";
						}

						return vis;
					})
					.text(function(d)
						{ 
							var strArray = d.data.name.split(".");
							strArray.pop();
							var formattedName = strArray.join(".").toString();
							return formattedName;
						})
					.style("font-size", "1px")
				    .each(getSize)
	  				.style("font-size", function(d) { return d.scale + "px"; })
		}	
	});

	//Reference: http://stackoverflow.com/questions/20115090/d3-js-auto-font-sizing-based-on-nodes-individual-radius-diameter
	function getSize(d) 
	{
  		var bbox = this.getBBox();
      	var cbbox = this.parentNode.getBBox();
      	var scale = Math.min(cbbox.width/bbox.width, cbbox.height/bbox.height);
  		d.scale = scale;
	}
</script>


