<!doctype html>
<html>
<head>
	<script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
	<script>	
		//Class Definitions
		class Package{
			constructor(Name, NumOfPackageDep, Dependencies){
				this.Name = Name;
				this.NumOfPackageDep = NumOfPackageDep;
				this.Dependencies = Dependencies;
			}

		}

		var Links = [];
		var classSizes = [];
		var Packages = [];
		var canvas_width = 960;
		var canvas_height = 500;
		var force;

		var canvasScale = d3.scaleLinear()
			.domain([0, canvas_width])
			.range([0, canvas_height]);

		var canvas = d3.select("body").append("svg")
			.attr("width", canvas_width)
			.attr("height", canvas_height)
			.attr("margin", "0px");
			
		var nodeGroup = canvas.append("g").attr("class", "nodes");
		var linkGroup = canvas.append("g").attr("class", "links");

		loadXML("./XML Files/hadoop_yarn.xml");

		//Specify the D3.xml file and the callback.

		//Functions
		function loadXML(path)
		{
			//Specify the xml file and the callbackwith D3.
			d3.xml(path, xmlCallback);
		}

		function CreateJSON(data)
		{
			//Create JSON structure.
			var packages = data.querySelectorAll("namespace");
			for(var k = 0; k < packages.length; k++)
			{
				var package = packages[k];
				var classes = package.querySelectorAll("type");

				//Add the new package.
				var findSource = findPackage(Packages, package.getAttribute("name"))
				if(findSource.length > 0)
				{
					//This means we already have an entry with this Package name.
					//This can happen when a package entry is added as part of another packages dependency definition below.
					//Update accordingly.
					Packages[Packages.indexOf(findSource[0])].size = classes.length;
				}
				else{
					//This means the package name is still not defined in the Packages node collection. So add the new entry.
					Packages.push({"id": package.getAttribute("name"), "size": classes.length});
				}
				for(var j = 0; j < classes.length; j++)
				{
					var c = classes[j];
					if(c.children.length > 0)
					{
						var cDependencies = c.children[0].children;
						for(var i = 0; i < cDependencies.length; i++)
							{
								var arr = cDependencies[i].getAttribute("name").split('.');
								//remove the class name from the FullName string.
								arr.pop(); 
								var namespaceStr = arr.join('.').toString();
								var newLink = {"source": package.getAttribute("name"), "target": namespaceStr};
								var found = findPackage(Packages, namespaceStr)
								if(found.length == 0)
								{
									Packages.push({"id": namespaceStr, "size": -1});
								}

								if(Links.indexOf(newLink) < 0)
								{
									Links.push(newLink);
								}
							}			
					}			
				}
			}
		}

		function findPackage(collection, namespace)
		{
			return collection.filter(function(data){
				return data.id == namespace;
			})
		}

		function xmlCallback(error, data)
		{
			if(error) 
			{
				throw error
			}
			else
			{
				//Create the JSON objects using the CDA generated XML.
				CreateJSON(data);

				console.log("Packages: " + Packages.length);
				console.log("Dependencies: " + Links.length);

		        /*Packages = [
		          {"id": "org.apache.hadoop.yarn.client.api", "size": 2},
		          {"id": "org.apache.hadoop.yarn.client.api.Bob", "size": 3},
		          {"id": "org.apache.hadoop.yarn.client.api.Carol", "size": 6}    
		        ];

		        Links = [
		          {"source": "org.apache.hadoop.yarn.client.api", "target": "org.apache.hadoop.yarn.client.api.Bob"},
		          {"source": "org.apache.hadoop.yarn.client.api.Carol", "target": "org.apache.hadoop.yarn.client.api.Bob"}
		        ];*/ 

				//Create the D3 Force Object.
				var simulation = d3.forceSimulation()
				    .force("link", d3.forceLink().id(function(d) { return d.id; }))
				    .force("charge", d3.forceManyBody().distanceMin(50).distanceMax(90).strength(-600))
				    .force("center", d3.forceCenter(canvas_width / 2, canvas_height / 2))
				    .force("collide", d3.forceCollide().radius(function(d) { return d.r + 200; }).iterations(9))
				    .nodes(Packages)
				    .on("tick", tick)
				    .force("link")
				    	.links(Links);

				var links = canvas.append("g").selectAll("line")
				    .data(Links)
				    .enter().append("line")
              			.attr("stroke", "#000")
              			.attr("stroke-width", "1.5px")
						.attr("class", "link");

				var nodes = canvas.selectAll("circle")
					.data(Packages)
					.enter()
						.append("circle")
						.attr("stroke", "black")
						.attr("stroke-width", 0.2)
						.attr("fill", "#78b567")
						.attr("r", 8)
						.attr("class", "node");

				function tick() {
				    nodes.attr("cx", function(d) { return d.x; })
				        .attr("cy", function(d) { return d.y; });

				    links.attr("x1", function(d) { return d.source.x; })
				        .attr("y1", function(d) { return d.source.y; })
				        .attr("x2", function(d) { return d.target.x; })
				        .attr("y2", function(d) { return d.target.y; });
				}				    
			}
		}		
	</script>
</body>
</html>


