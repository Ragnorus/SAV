<!DOCTYPE html>
<meta charset="utf-8">
<style>

.show circle {
	visibility: visible;
}

</style>
<svg width="980" height="980"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="./d3/d3.js"></script> <!-- This is version 4 of the D3 Library -->
<script src="./d3/d3.min.js"></script> <!-- This is version 4 of the D3 min Library -->
<script>	
	var Containers = [];
	var canvas_width = 960;
	var canvas_height = 960;

	var canvas = d3.select("svg")
		.attr("width", canvas_width)
		.attr("height", canvas_height)
		.append("g")
			.attr("transform", "translate(2, 2)");

	loadXML("./XML Files/all-of-pmd.xml");

	//Functions
	function loadXML(path)
	{
		//Specify the xml file and the callbackwith D3.
		d3.xml(path, xmlCallback);
	}

	function CreateJSON(data)
	{
		//Create JSON structure for the Pack.
		var containers = data.querySelectorAll("container");
		for(var k = 0; k < containers.length; k++)
		{
			var container = containers[k];
			var packages = container.querySelectorAll("namespace");
			var containerSize = packages.length;
			var packageArray = [];

			for(var j = 0; j < containerSize; j++)
			{
				var packageSize = packages[j].querySelectorAll("type").length;
				var packageName = packages[j].getAttribute("name");

				var strArr = packageName.split(".")
				packageArray.push({"name": packageName, "size": packageSize});

				//TODO: I need to investigate duplicate JAR Files. If there are duplicate JAR files then we need to show their path to validate that they're copies throughout the system. 
				//and not just the same file in our data being a duplicate.
			}				
			var lastElementIndex = container.getAttribute("name").split("/").length - 1;
			var containerName = container.getAttribute("name").split("/")[lastElementIndex]; //CDA usually places the absolute path to the JAR file. Let's only grab the actual name.
			Containers.push({"name": containerName, "size": packages.length, "children": packageArray});
		}

		var context = data.querySelectorAll("context")[0].getAttribute("name");
		return {"name": context, "children": Containers}
	}

	function xmlCallback(error, data)
	{
		if(error) 
		{
			throw error
		}
		else
		{
			//Create the JSON objects using the CDA generated XML.
			var jsondata = CreateJSON(data);

			var root = d3.hierarchy(jsondata)
				.sum(function(d) { return d.size; })
				.sort(function(d) {return d.name; });

			// A scale for the circle's radius relative to their size. Size is calculcated using the number of children inside.
			// Example:
			// - Container - total number of JAR files
			// - JAR file - total number of packages
			// - Package = total number of class/interface files inside that package.
			var circleScale = d3.scaleLinear()
				.domain([0, d3.max(jsondata, function(d){ return d.size; })])
				.range([15, 900]);

			//TODO: investigate if we need a scale for package circles and a separate scale for JAR circles.

			//Create the pack
			var systemPack = d3.pack()
				.size([canvas_width, canvas_height])
				.padding(2);

			//Create their circle containers that will be drawn into the canvas.
			var node = canvas.selectAll(".package")
					.data(systemPack(root).descendants())
					.enter()
						.append("g")
								.attr("id", function(d){ return d.data.name; })
								.attr("class", "node")
								.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

			node.append("circle")				
				.attr("stroke", "black")
				.attr("stroke-width", 0.2)
				.attr("fill", function(d)
				{ 
					var color =  "black"; //default

					if(d.depth == 0) //root node.
					{
						//Mid Gray
						color = "#a0acbf";
					}
					else if(d.children) //Mid node.
					{
						//Greyish blue
						color = "#6284bc";
					}
					else if(!d.children) //leaf node
					{
						//royal blue
						color = "#1f69e2"; 
					}

					return color;
				})
				.attr("r", function(d) { 
					//if(d.depth == 0)
					//{
						return d.r;
					//}
					//else
					//{
						//return d.r = circleScale(d.data.size); 
					//}
				})
				.style("visibility", function(d){ 
					var vis =  "hidden"; //default
					if(d.depth == 0)
					{
						vis =  "visible";
					}
					else if(d.children) //Mid node.
					{
						vis =  "visible";
					}
					else
					{
						vis = "hidden"
					}

					return vis;
				})
				.on("mouseover", function(d){ 
					d3.select(this).style("stroke-width", 2);

					if(d.depth != 0 && d.children)
					{
						var children = d.children;
						for(var i = 0; i < children.length; i++)
						{
							var identifier = "#" + children[i].data.name;
							d3.select(identifier).selectAll("circle").each(function(d){
								d3.select(this).style("visibility", "visible");
							})//.style("visibility", "visible");
							d3.select(identifier).selectAll("text").each(function(d){
								d3.select(this).style("visibility", "visible");
							})//.style("visibility", "visible");
						}
					}
				})
				.on("mouseout", function(d){			
					d3.select(this).style("stroke-width", 0.2);
					console.log("Parent Node:")
					console.log(this);
					if(d.depth != 0 && d.children)
					{
						var children = d.children;
						for(var i = 0; i < children.length; i++)
						{
							var identifier = "#" + children[i].data.name;
							d3.select(identifier).selectAll("circle").each(function(d){
								console.log("Child Node:")
								console.log(this);
								d3.select(this).style("visibility", "hidden");
							})
							d3.select(identifier).selectAll("text").each(function(d){
								d3.select(this).style("visibility", "hidden");
							})
						}
					}
				});
				//.call(d3.zoom().on("dblclick", handleZoom));

			node.append("text")
				.attr("fill", "black")
				.attr("font-family", "Arial")
				.attr("font-size", "5px")
				.attr("text-anchor", "middle")
				.attr("visibility", function(d){
					var vis = "hidden";
					if(d.children) //mid node
					{
						vis = "visible";
					}

					return vis;
				})
				.text(function(d){ return d.data.name; });
		}

		function handleZoom(event)
		{
			d3.zoom().scaleTo(event.target, 5);
		}
	}		
</script>


