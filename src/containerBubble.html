<!DOCTYPE html>
<meta charset="utf-8">
<title> Pack View </title>
<style>

/* The .d3-tip template used in the tooltip can be found in: https://rawgit.com/Caged/d3-tip/master/examples/example-styles.css */
.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
  pointer-events: none;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  position: absolute;
  pointer-events: none;
}

/* Northward tooltips */
.d3-tip.n:after {
  content: "\25BC";
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
  text-align: center;
}

/* Eastward tooltips */
.d3-tip.e:after {
  content: "\25C0";
  margin: -4px 0 0 0;
  top: 50%;
  left: -8px;
}

/* Southward tooltips */
.d3-tip.s:after {
  content: "\25B2";
  margin: 0 0 1px 0;
  top: -8px;
  left: 0;
  text-align: center;
}

/* Westward tooltips */
.d3-tip.w:after {
  content: "\25B6";
  margin: -4px 0 0 -1px;
  top: 50%;
  left: 100%;
}

</style>
<svg width="980" height="980"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="./d3/d3.js"></script> <!-- This is version 4 of the D3 Library -->
<script src="./d3/d3.min.js"></script> <!-- This is version 4 of the D3 min Library -->
<script type="text/javascript" src="./d3-tip/index.js"></script>
<script type="text/javascript">


	var Containers = [],
	default_stroke_width = 0.5,
	highlight_stroke_width = 2,
	canvas_width = 960,
	canvas_height = 960,
	margin = 3,
	//Transition definition for when we switch on/off the visibility of a node.
	visibilityTransition = d3.transition().delay(1000).ease(d3.easeLinear),
	c20c = d3.schemeCategory20c,
	svg = d3.select("svg")
		.attr("fill", "black")
		.attr("width", canvas_width)
		.attr("height", canvas_height),
	canvas = svg.append("g").attr("transform", "translate(" + canvas_width / 2 + "," + canvas_height / 2 + ")"),
	tooltip = d3.tip()
		.attr('class', 'd3-tip')
		.html(function(d) { return d.data.name; } );

	canvas.call(tooltip);

	function setNodeFill(d)
	{
		var color =  "black"; //default

		if(d.depth == 0) //root node.
		{
			//Mid Gray
			color = "#a0acbf";
		}
		else if(d.children) //Mid node.
		{
			//Greyish blue
			color = "#6284bc";
		}
		else if(!d.children) //leaf node
		{
			//royal blue
			color = "#1f69e2";
		}

		return color;			
	}

	function setNodeVisibility(d)
	{
		var vis =  "hidden"; //default
		if(d.depth == 0)
		{
			vis =  "visible";
		}
		else if(d.children) //Mid node.
		{
			vis =  "visible";
		}
		else
		{
			vis = "hidden"
		}

		return vis;
	}

	function handleMouseClick(d)
	{		
		if(!d.children)
		{
			window.location.href = "http://localhost:8080/packageNodes.html?container=\"" + d.parent.data.name + "\"" + "&package=\"" + d.data.name + "\"";
		}
	}

	function handleNodeMouseOver(d)
	{
		if(d.depth != 0)
		{
			//Show tooltip
			tooltip.show(d);
			d3.select(this).style("stroke-width", highlight_stroke_width);
		}			
	}

	function handleNodeMouseOut(d)
	{
		//Show tooltip
		tooltip.hide(d);
		d3.select(this).style("stroke-width", default_stroke_width);
	}

	function getMidNodes(descendants)
	{
		var midNodes = [];
		for(i = 0; i < descendants.length; i++)
		{
			if(descendants[i].children) //We want non-leaf-nodes.
			{
				midNodes.push(descendants[i]);
			}
		}

		return midNodes;
	}

	function filterSmallNodes(descendants)
	{
		var midNodes = [];
		for(i = 0; i < descendants.length; i++)
		{
			if(descendants[i].depth == 0 || descendants[i].data.size > 1)
			{
				midNodes.push(descendants[i]);
			}
		}

		return midNodes;
	}	

	d3.json("output.json", function(error, data)
	{
		if(error) 
		{
			throw error
		}
		else
		{
			//Create the JSON objects using the CDA generated XML.
			var root = d3.hierarchy(data)
				.sum(function(d) { return d.size; })
				.sort(function(a, b) { return b.value - a.value; });

			// A scale for the circle's radius relative to their size. Size is calculcated using the number of children inside.
			// Example:
			// - Container - total number of JAR files
			// - JAR file - total number of packages
			// - Package = total number of class/interface files inside that package.
			var textScale = d3.scaleLinear()
				.domain([1, d3.max(data, function(d){ return d.size; })])
				.range([2, 30]);

			var packageScale = d3.scaleLinear()
				.domain([0, d3.max(data, function(d){ return d.size; })])
				.range([1, 20]);

			//Create the pack
			var systemPack = d3.pack()
				.size([canvas_width - margin, canvas_height - margin])
				.padding(2);

			//Create their circle containers that will be drawn into the canvas.
			var packNode = canvas.selectAll("circle")
					.data(filterSmallNodes(systemPack(root).descendants()))
					.enter()
					.append("circle")
						.attr("class", "midNode")			
						.attr("stroke", "black")
						.attr("stroke-width", default_stroke_width)
						.attr("fill", setNodeFill)
						.attr("r", function(d){ return d.r; })
						//.style("visibility", setNodeVisibility)
						.on("click", function(d) { if (root !== d && d.depth != 2) zoom(d), d3.event.stopPropagation(); })
						.on("mouseover", handleNodeMouseOver)
						.on("mouseout", handleNodeMouseOut)
						.on("dblclick", handleMouseClick);

			var text = canvas.selectAll("text")
					.data(filterSmallNodes(systemPack(root).descendants()))
					.enter()
			        .append("text")
			        .attr("class", "midNode")
					.attr("fill", "black")
					.attr("font-family", "sans-serif")
					.attr("font-size", function(d){
						if(d.size < 5)
						{
							return "1px";
						}
						else
						{
							return "5px";
						}
					})//function(d){ return textScale(d.size).toString() + "px" })
					.attr("text-anchor", "middle")
					.style("display", function(d) { return d.parent === root ? "inline" : "none"; })
					.text(function(d)
						{ 
							var strArray = d.data.name.split(".");
							if(strArray[strArray.length - 1] == "jar")
							{
							  strArray.pop();
						    }
							var formattedName = strArray.join(".").toString();
							return formattedName;
						});
		}
		  var svgElements = canvas.selectAll("circle,text");
		  svg.on("click", function() { zoom(root); });
		  zoomTo([root.x, root.y, root.r * 2 + margin]);

		  //For the Zoom mechanic: https://bl.ocks.org/mbostock/7607535
		  function zoom(d) {
		    var prevRoot = root; root = d;
		    var transition = d3.transition()
		        .duration(d3.event.altKey ? 7500 : 750)
		        .tween("zoom", function(d) {
		          var i = d3.interpolateZoom(view, [root.x, root.y, root.r * 2 + margin]);
		          return function(t) { zoomTo(i(t)); };
		        });

		    transition.selectAll("text")
		      .filter(function(d) { return d.parent === root || this.style.display === "inline"; })
		        .style("fill-opacity", function(d) { return d.parent === root ? 1 : 0; })
		        .on("start", zoomStart)
		        .on("end", zoomEnd);
		   }

		  function zoomTo(v) {
		    var k = canvas_width / v[2]; view = v;
		    svgElements.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k + "," + (d.y - v[1]) * k + ")"; });
		    packNode.attr("r", function(d) { return d.r * k; });
		  }

		  function zoomEnd(d)
		  {
			if (d.parent !== root) 
			{
				this.style.display = "none";
			}
		  }

		  function zoomStart(d)
		  {
		  	if (d.parent === root) 
		  	{
		  		this.style.display = "inline"; 
		  	}		  	
		  }

		function deleteLeafNodes()
		{
			canvas.selectAll(".packageSVG").remove();
		}

		function drawLeafNodes(d)
		{
				//Create their circle containers that will be drawn into the canvas.
				canvas.selectAll("circle")
						.data(d.children)
							.enter()
								.append("circle")
									.attr("class", "packageSVG")		
									.attr("stroke", "black")
									.attr("stroke-width", default_stroke_width)
									.attr("fill", setNodeFill)
									.attr("r", function(d){ return d.r; })
									//.style("visibility", setNodeVisibility)
									.on("dblclick", handleMouseClick);

				canvas.selectAll("text")
						.data(d.children)
							.enter()
					        	.append("text")
							        .attr("class", "packageSVG")
									.attr("fill", "black")
									.attr("font-family", "sans-serif")
									.attr("font-size", "5px")
									.attr("text-anchor", "middle")
									.style("display", function(d) { return d.parent === root ? "inline" : "none"; })
									.text(function(d)
										{ 
											var strArray = d.data.name.split(".");
											strArray.pop();
											var formattedName = strArray.join(".").toString();
											return formattedName;
										});
		}		  
	});

</script>


