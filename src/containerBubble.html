<!DOCTYPE html>
<meta charset="utf-8">
<style>

.show circle {
	visibility: visible;
}

</style>
<svg width="980" height="980"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="./d3/d3.js"></script> <!-- This is version 4 of the D3 Library -->
<script src="./d3/d3.min.js"></script> <!-- This is version 4 of the D3 min Library -->
<script>	
	var Containers = [];
	var default_stroke_width = 0.5;
	var highlight_stroke_width = 2;
	var canvas_width = 960;
	var canvas_height = 960;
	//Transition definition for when we switch on/off the visibility of a node.
	var visibilityTransition = d3.transition().delay(1000).ease(d3.easeLinear);
	var c20c = d3.schemeCategory20c;
	var canvas = d3.select("svg")
		.attr("fill", "black")
		.attr("width", canvas_width)
		.attr("height", canvas_height)
		.append("g")
			.attr("transform", "translate(2, 2)");

	function setNodeRadius(d)
	{
		//if(d.depth == 0)
		//{
			return d.r;
		//}
		//else
		//{
			//return d.r = circleScale(d.data.size); 
		//}			
	}

	function setNodeFill(d)
	{
		var color =  "black"; //default

		if(d.depth == 0) //root node.
		{
			//Mid Gray
			color = "#a0acbf";
			//color = "#003182";
			//color = "#462284";
			//color = "#1f69e2";
		}
		else if(d.children) //Mid node.
		{
			//Greyish blue
			color = "#6284bc";
			//color = "#6b13b2";
		}
		else if(!d.children) //leaf node
		{
			//royal blue
			color = "#1f69e2";
			//color = "#5e9aff";
			//color  = "#bd41f2";
			//color = "#a0acbf";
		}

		return color;			
	}

	function setNodeOpacity(d)
	{
		var opacity =  0.1;

		if(d.depth == 0) //root node.
		{
			opacity = 0.3;
		}
		else if(d.children) //Mid node.
		{
			opacity = 0.5;
		}
		else //leaf node
		{
			opacity = 1; 
		}

		return opacity;			
	}

	function setNodeVisibility(d)
	{
		/*var vis =  "hidden"; //default
		if(d.depth == 0)
		{
			vis =  "visible";
		}
		else if(d.children) //Mid node.
		{
			vis =  "visible";
		}
		else
		{
			vis = "hidden"
		}

		return vis;	*/

		return "visible"		
	}

	function handleMouseClick(d)
	{		
		if(!d.children)
		{
			window.location.href = "http://localhost:8080/packageNodes.html";
		}
	}

	var currentPackage;
	function handleNodeMouseOver(d)
	{		
		if(d.depth != 0 && d.children)
		{
			currentPackage = d;
			//d3.select(this).style("stroke", "white");
			d3.select(this).style("stroke-width", highlight_stroke_width);
			if(d.depth != 0)
			{
				for(i = 0; i < d.children.length; i++)
				{
					d3.select("#" + d.children[i].data.id).select("circle").style("visibility", "visible");
				}
			}
		}			
	}

	function handleNodeMouseOut(d)
	{
		//d3.select(this).style("stroke", "white");
		d3.select(this).style("stroke-width", default_stroke_width);
		/*if(currentPackage != d || currentPackage != d.parent)
		{
			if(d.depth != 2 && d.children)
			{
				d3.select(this).style("stroke-width", default_stroke_width);
				if(d.depth != 0)
				{
					for(i = 0; i < d.children.length; i++)
					{
						d3.select("#" + d.children[i].data.id).select("circle").style("visibility", "hidden");
					}
				}
			}
		}*/
	}

	function handleZoom(event)
	{
		d3.zoom().scaleTo(event.target, 5);
	}

	d3.json("output.json", function(error, data)
	{
		if(error) 
		{
			throw error
		}
		else
		{
			//Create the JSON objects using the CDA generated XML.
			var root = d3.hierarchy(data)
				.sum(function(d) { return d.size; })
				.sort(function(d) {return d.name; });

			// A scale for the circle's radius relative to their size. Size is calculcated using the number of children inside.
			// Example:
			// - Container - total number of JAR files
			// - JAR file - total number of packages
			// - Package = total number of class/interface files inside that package.
			var circleScale = d3.scaleLinear()
				.domain([0, d3.max(data, function(d){ return d.size; })])
				.range([15, 900]);

			//TODO: investigate if we need a scale for package circles and a separate scale for JAR circles.

			//Create the pack
			var systemPack = d3.pack()
				.size([canvas_width - 3, canvas_height - 3])
				.padding(2);

			//Create their circle containers that will be drawn into the canvas.
			var nodes = canvas.selectAll(".package")
					.data(systemPack(root).descendants())
					.enter()
						.append("g")
								.attr("id", function(d) { return d.data.id; })
								.attr("class", "node")
								.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

			nodes.append("circle")				
				.attr("stroke", "black")
				.attr("stroke-width", default_stroke_width)
				.attr("fill", setNodeFill)
				//.attr("opacity", setNodeOpacity)
				.attr("r", setNodeRadius)
				.style("visibility", setNodeVisibility)
				.on("mouseover", handleNodeMouseOver)
				.on("mouseout", handleNodeMouseOut)
				.on("click", handleMouseClick);
				//.call(d3.zoom().on("dblclick", handleZoom));

			var text = nodes.append("text")
				.attr("fill", "black")
				.attr("font-family", "Arial")
				.attr("font-size", "5px")
				.attr("text-anchor", "middle")
				.attr("visibility", function(d){
					var vis = "hidden";
					if(d.children) //mid node
					{
						vis = "visible";
					}

					return vis;
				})
				.text(function(d){ return d.data.name; });
		}
	})	
</script>


